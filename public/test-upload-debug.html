<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste de Upload - Debug</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Teste de Upload - Submiss√£o de Trabalhos</h1>
  <input type="file" id="fileInput" accept=".pdf,.docx">
  <button onclick="testUpload()">Testar Upload</button>
  <pre id="output"></pre>

  <script>
    const SUPABASE_URL = "https://wdkeqxfglmritghmakma.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indka2VxeGZnbG1yaXRnaG1ha21hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyNDc0ODksImV4cCI6MjA2NTgyMzQ4OX0.h-HiLfyMh2EaYWQro1TvCVROwHnOJDyynsUIptmhKuo";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const output = document.getElementById('output');

    async function testUpload() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        output.textContent = 'Por favor, selecione um arquivo';
        return;
      }

      output.textContent = 'üîÑ Testando upload...\n\n';
      output.textContent += `üìÅ Arquivo: ${file.name}\n`;
      output.textContent += `üìä Tamanho: ${(file.size / 1024).toFixed(2)} KB\n`;
      output.textContent += `üìù Tipo: ${file.type}\n\n`;

      // Testar se o bucket existe
      output.textContent += '1Ô∏è‚É£ Verificando bucket...\n';
      try {
        const { data: buckets, error: bucketsError } = await supabase.storage.listBuckets();
        
        if (bucketsError) {
          output.textContent += `‚ùå Erro ao listar buckets: ${bucketsError.message}\n`;
          output.textContent += `Detalhes: ${JSON.stringify(bucketsError, null, 2)}\n`;
          return;
        }
        
        const workSubmissionsBucket = buckets.find(b => b.name === 'work-submissions');
        if (!workSubmissionsBucket) {
          output.textContent += '‚ùå Bucket "work-submissions" n√£o encontrado!\n';
          output.textContent += `Buckets dispon√≠veis: ${buckets.map(b => b.name).join(', ')}\n`;
          return;
        }
        
        output.textContent += `‚úÖ Bucket encontrado: ${JSON.stringify(workSubmissionsBucket, null, 2)}\n\n`;
      } catch (e) {
        output.textContent += `‚ùå Exce√ß√£o ao verificar bucket: ${e.message}\n`;
        return;
      }

      // Testar upload
      output.textContent += '2Ô∏è‚É£ Tentando upload...\n';
      const filePath = `test/${Date.now()}_${file.name}`;
      
      try {
        const { data, error } = await supabase.storage
          .from('work-submissions')
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false,
            contentType: file.type
          });

        if (error) {
          output.textContent += `‚ùå ERRO NO UPLOAD:\n`;
          output.textContent += `Mensagem: ${error.message}\n`;
          output.textContent += `Nome: ${error.name}\n`;
          output.textContent += `Status: ${error.status || 'N/A'}\n`;
          output.textContent += `Detalhes completos:\n${JSON.stringify(error, null, 2)}\n`;
          return;
        }

        output.textContent += `‚úÖ UPLOAD BEM-SUCEDIDO!\n`;
        output.textContent += `Caminho: ${data.path}\n`;
        output.textContent += `ID: ${data.id}\n`;
        output.textContent += `Detalhes:\n${JSON.stringify(data, null, 2)}\n`;

        // Testar URL p√∫blica
        const { data: urlData } = supabase.storage
          .from('work-submissions')
          .getPublicUrl(filePath);

        output.textContent += `\nüîó URL P√∫blica: ${urlData.publicUrl}\n`;
        
      } catch (e) {
        output.textContent += `‚ùå EXCE√á√ÉO:\n`;
        output.textContent += `${e.message}\n`;
        output.textContent += `Stack:\n${e.stack}\n`;
      }
    }
  </script>
</body>
</html>
