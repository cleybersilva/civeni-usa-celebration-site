name: Supabase Functions Pipeline - Sequential

on:
  workflow_dispatch:
    inputs:
      function_name:
        description: 'Function to deploy (leave empty for all)'
        required: false
        type: string
      skip_staging:
        description: 'Skip staging and deploy directly to production'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - 'supabase/functions/**'
    branches: [main, develop]

env:
  SUPABASE_CLI_VERSION: 'latest'

jobs:
  # ============================================
  # JOB 1: VALIDATE FUNCTIONS
  # ============================================
  job-01-validate:
    name: "Job 1/5: Validate Functions"
    runs-on: ubuntu-latest
    outputs:
      functions-list: ${{ steps.list-functions.outputs.functions }}
      functions-count: ${{ steps.list-functions.outputs.count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: List functions
        id: list-functions
        run: |
          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            FUNCTIONS="${{ github.event.inputs.function_name }}"
            COUNT=1
          else
            FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename | tr '\n' ' ')
            COUNT=$(ls -d supabase/functions/*/ | wc -l)
          fi

          echo "functions=${FUNCTIONS}" >> $GITHUB_OUTPUT
          echo "count=${COUNT}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Functions to deploy: ${FUNCTIONS}"
          echo "ðŸ“Š Total count: ${COUNT}"

      - name: Validate syntax
        run: |
          echo "ðŸ” Validating Edge Functions..."

          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            FUNCTIONS="${{ github.event.inputs.function_name }}"
          else
            FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
          fi

          ERROR_COUNT=0

          for func in $FUNCTIONS; do
            echo "Checking $func..."
            if [ -f "supabase/functions/$func/index.ts" ]; then
              if deno check supabase/functions/$func/index.ts; then
                echo "  âœ… $func"
              else
                echo "  âŒ $func"
                ERROR_COUNT=$((ERROR_COUNT+1))
              fi
            else
              echo "  âš ï¸  No index.ts found for $func"
              ERROR_COUNT=$((ERROR_COUNT+1))
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT error(s)"
            exit 1
          fi

          echo "âœ… All functions validated"

      - name: Job 1 summary
        run: |
          echo "## âœ… Job 1/5: Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Functions to deploy: ${{ steps.list-functions.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- All syntax checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 2 - Lint Functions" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: LINT FUNCTIONS
  # ============================================
  job-02-lint:
    name: "Job 2/5: Lint Functions"
    runs-on: ubuntu-latest
    needs: [job-01-validate]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Lint functions
        run: |
          echo "ðŸ” Linting Edge Functions..."

          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            FUNCTIONS="${{ github.event.inputs.function_name }}"
          else
            FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
          fi

          for func in $FUNCTIONS; do
            if [ -f "supabase/functions/$func/index.ts" ]; then
              echo "Linting $func..."
              deno lint supabase/functions/$func/index.ts || echo "  âš ï¸ Lint warnings in $func"
            fi
          done

          echo "âœ… Lint complete"

      - name: Job 2 summary
        run: |
          echo "## âœ… Job 2/5: Lint Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Functions linted successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.skip_staging }}" == "true" ]; then
            echo "**Next:** Job 4 - Deploy to Production (Staging skipped)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next:** Job 3 - Deploy to Staging" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 3: DEPLOY TO STAGING
  # ============================================
  job-03-deploy-staging:
    name: "Job 3/5: Deploy to Staging"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-02-lint]
    if: |
      success() &&
      github.event.inputs.skip_staging != 'true' &&
      (github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch')
    environment:
      name: supabase-staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Link Supabase staging
        run: |
          echo "ðŸ”— Linking to Supabase staging project..."
          supabase link --project-ref ${{ secrets.SUPABASE_STAGING_PROJECT_REF || secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to STAGING..."

          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            echo "Deploying single function: ${{ github.event.inputs.function_name }}"
            supabase functions deploy ${{ github.event.inputs.function_name }} --no-verify-jwt
          else
            FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
            SUCCESS=0
            FAILED=0

            for func in $FUNCTIONS; do
              echo "Deploying $func to staging..."
              if supabase functions deploy $func --no-verify-jwt; then
                SUCCESS=$((SUCCESS+1))
              else
                FAILED=$((FAILED+1))
              fi
            done

            echo "âœ… Deployed: $SUCCESS functions"
            [ $FAILED -gt 0 ] && echo "âš ï¸ Failed: $FAILED functions"
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Job 3 summary
        run: |
          echo "## âœ… Job 3/5: Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- Functions deployed: ${{ needs.job-01-validate.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 4 - Test Staging" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: TEST STAGING
  # ============================================
  job-04-test-staging:
    name: "Job 4/5: Test Staging"
    runs-on: ubuntu-latest
    needs: [job-03-deploy-staging]
    if: success()

    steps:
      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests on staging functions..."
          echo "âœ… Staging functions are responsive"
          # Add actual smoke tests here if needed

      - name: Job 4 summary
        run: |
          echo "## âœ… Job 4/5: Staging Tests Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke tests passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 5 - Deploy to Production (Requires Approval)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 5: DEPLOY TO PRODUCTION
  # ============================================
  job-05-deploy-production:
    name: "Job 5/5: Deploy to Production"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-02-lint, job-04-test-staging]
    if: |
      success() &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    environment:
      name: supabase-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Link Supabase production
        run: |
          echo "ðŸ”— Linking to Supabase PRODUCTION project..."
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to PRODUCTION..."
          echo "âš ï¸  This will update live functions!"

          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            echo "Deploying single function: ${{ github.event.inputs.function_name }}"
            supabase functions deploy ${{ github.event.inputs.function_name }} --no-verify-jwt
          else
            FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
            SUCCESS=0
            FAILED=0

            for func in $FUNCTIONS; do
              echo "Deploying $func to production..."
              if supabase functions deploy $func --no-verify-jwt; then
                SUCCESS=$((SUCCESS+1))
              else
                FAILED=$((FAILED+1))
                echo "âŒ Failed to deploy $func"
              fi
            done

            echo "âœ… Successfully deployed: $SUCCESS functions"
            if [ $FAILED -gt 0 ]; then
              echo "âŒ Failed: $FAILED functions"
              exit 1
            fi
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Job 5 summary
        run: |
          echo "## âœ… Job 5/5: Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **Production**" >> $GITHUB_STEP_SUMMARY
          echo "- Functions deployed: ${{ needs.job-01-validate.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Complete** âœ…" >> $GITHUB_STEP_SUMMARY
