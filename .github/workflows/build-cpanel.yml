name: Build cPanel Package

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Build mode'
        required: true
        type: choice
        options:
          - production
          - development
        default: production
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Package for cPanel
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (Production)
        if: ${{ github.event.inputs.mode == 'production' || startsWith(github.ref, 'refs/tags/') }}
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Build (Development)
        if: ${{ github.event.inputs.mode == 'development' }}
        run: npm run build:dev
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Prepare cPanel package
        run: |
          echo "Creating cPanel deployment package..."

          # Create deployment directory
          mkdir -p cpanel-package

          # Copy dist contents
          cp -r dist/* cpanel-package/

          # Copy .htaccess if it exists
          if [ -f .htaccess ]; then
            cp .htaccess cpanel-package/
          fi

          # Copy robots.txt if it exists
          if [ -f public/robots.txt ]; then
            cp public/robots.txt cpanel-package/
          fi

          # List contents
          echo "Package contents:"
          ls -lah cpanel-package/

      - name: Create ZIP archive
        run: |
          cd cpanel-package
          zip -r ../civeni-saas-cpanel.zip .
          cd ..

          echo "Archive created:"
          ls -lh civeni-saas-cpanel.zip

          # Calculate checksum
          sha256sum civeni-saas-cpanel.zip > civeni-saas-cpanel.zip.sha256

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cpanel-package-${{ github.event.inputs.mode || 'production' }}-${{ github.sha }}
          path: |
            civeni-saas-cpanel.zip
            civeni-saas-cpanel.zip.sha256
          retention-days: 30

      - name: Create Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            civeni-saas-cpanel.zip
            civeni-saas-cpanel.zip.sha256
          body: |
            ## cPanel Deployment Package

            Build mode: Production
            Git SHA: ${{ github.sha }}

            ### Installation Instructions
            1. Download `civeni-saas-cpanel.zip`
            2. Log in to cPanel File Manager
            3. Navigate to `public_html/` (or your domain root)
            4. Upload and extract the ZIP file
            5. Verify `.htaccess` is present
            6. Test the deployment

            ### Checksum
            Verify integrity with: `sha256sum -c civeni-saas-cpanel.zip.sha256`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deployment summary
        run: |
          echo "âœ… Build completed successfully"
          echo "Build mode: ${{ github.event.inputs.mode || 'production' }}"
          echo "Artifact: civeni-saas-cpanel.zip"
          echo ""
          echo "Download the artifact from the Actions tab to deploy to cPanel"
