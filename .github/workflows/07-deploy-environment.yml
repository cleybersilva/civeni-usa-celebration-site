name: "07 - Deploy to Environment"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: cpanel-package-${{ github.sha }}

      - name: Verify package integrity
        run: |
          echo "üîç Verificando integridade do pacote..."
          sha256sum -c civeni-cpanel.zip.sha256
          echo "‚úÖ Checksum validado com sucesso!"

      - name: Extract package
        run: |
          echo "üì¶ Extraindo pacote de deploy..."
          mkdir -p cpanel-package
          unzip -q civeni-cpanel.zip -d cpanel-package
          echo "‚úÖ Pacote extra√≠do: $(ls -lh cpanel-package | wc -l) arquivos"

      - name: Verify extracted contents
        run: |
          echo "üîç Verificando arquivos essenciais..."
          test -f cpanel-package/index.html && echo "‚úÖ index.html encontrado" || (echo "‚ùå index.html n√£o encontrado" && exit 1)
          test -f cpanel-package/.htaccess && echo "‚úÖ .htaccess encontrado" || echo "‚ö†Ô∏è .htaccess n√£o encontrado"
          test -d cpanel-package/assets && echo "‚úÖ pasta assets/ encontrada" || (echo "‚ùå pasta assets/ n√£o encontrada" && exit 1)

      - name: Prepare deployment configuration
        id: deploy-config
        run: |
          # Garantir que server-dir termine com /
          SERVER_DIR="${{ secrets.FTP_SERVER_DIR }}"
          if [ -z "$SERVER_DIR" ]; then
            SERVER_DIR="/public_html/"
          elif [[ "$SERVER_DIR" != */ ]]; then
            SERVER_DIR="${SERVER_DIR}/"
          fi
          echo "server-dir=$SERVER_DIR" >> $GITHUB_OUTPUT
          echo "üìÅ Diret√≥rio de destino: $SERVER_DIR"

          # Detectar m√©todo de deploy preferido
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "deploy-method=ssh" >> $GITHUB_OUTPUT
            echo "üîê M√©todo detectado: SSH/SFTP (recomendado)"
          else
            echo "deploy-method=ftp" >> $GITHUB_OUTPUT
            echo "üì° M√©todo detectado: FTP/FTPS"
          fi

      - name: Setup SSH key (if using SSH deploy)
        if: steps.deploy-config.outputs.deploy-method == 'ssh'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.FTP_SERVER }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "‚úÖ SSH key configurada"

      - name: Deploy via SFTP/SCP (Recommended)
        if: steps.deploy-config.outputs.deploy-method == 'ssh'
        run: |
          echo "üöÄ Iniciando deploy via SFTP..."

          # Usar rsync over SSH (mais eficiente)
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT || 22 }}" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            ./cpanel-package/ \
            ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:${{ steps.deploy-config.outputs.server-dir }}

          echo "‚úÖ Deploy via SFTP conclu√≠do!"

      - name: Test FTP/SFTP connectivity
        id: connectivity-test
        continue-on-error: true
        run: |
          echo "üîç Testando conectividade..."

          FTP_PORT="${{ secrets.FTP_PORT || 2121 }}"

          # Testar FTP (porta 2121 ou customizada)
          echo "üîç Testando FTP na porta $FTP_PORT..."
          if timeout 5 bash -c "</dev/tcp/${{ secrets.FTP_SERVER }}/$FTP_PORT" 2>/dev/null; then
            echo "‚úÖ Porta FTP ($FTP_PORT) est√° aberta"
            echo "ftp-available=true" >> $GITHUB_OUTPUT
            echo "ftp-port=$FTP_PORT" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Porta FTP ($FTP_PORT) est√° fechada ou inacess√≠vel"
            echo "ftp-available=false" >> $GITHUB_OUTPUT

            # Tentar porta padr√£o 21 tamb√©m
            echo "üîç Testando FTP na porta padr√£o 21..."
            if timeout 5 bash -c "</dev/tcp/${{ secrets.FTP_SERVER }}/21" 2>/dev/null; then
              echo "‚úÖ Porta FTP (21) est√° aberta"
              echo "ftp-available=true" >> $GITHUB_OUTPUT
              echo "ftp-port=21" >> $GITHUB_OUTPUT
            fi
          fi

          # Testar SFTP (porta 22)
          echo "üîç Testando SSH/SFTP na porta 22..."
          if timeout 5 bash -c "</dev/tcp/${{ secrets.FTP_SERVER }}/22" 2>/dev/null; then
            echo "‚úÖ Porta SSH/SFTP (22) est√° aberta"
            echo "ssh-available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Porta SSH/SFTP (22) est√° fechada ou inacess√≠vel"
            echo "ssh-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy via SFTP with password (using sshpass)
        if: steps.deploy-config.outputs.deploy-method == 'ftp' && steps.connectivity-test.outputs.ssh-available == 'true'
        id: sftp-deploy
        continue-on-error: true
        run: |
          echo "üöÄ Tentando deploy via SFTP (porta 22)..."

          # Instalar sshpass para autentica√ß√£o com senha
          sudo apt-get update -qq
          sudo apt-get install -y sshpass rsync

          # Extrair username (remover @dominio se existir)
          USERNAME="${{ secrets.FTP_USERNAME }}"
          USERNAME="${USERNAME%%@*}"

          echo "üì° Conectando em: ${{ secrets.FTP_SERVER }}:22"
          echo "üë§ Usu√°rio: $USERNAME"

          # Usar rsync over SSH com senha via sshpass
          sshpass -p "${{ secrets.FTP_PASSWORD }}" \
            rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p 22" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            ./cpanel-package/ \
            $USERNAME@${{ secrets.FTP_SERVER }}:${{ steps.deploy-config.outputs.server-dir }}

          if [ $? -eq 0 ]; then
            echo "‚úÖ Deploy via SFTP conclu√≠do com sucesso!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå SFTP falhou"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Deploy via FTP/FTPS (Last Resort Fallback)
        if: steps.deploy-config.outputs.deploy-method == 'ftp' && steps.sftp-deploy.outcome != 'success' && steps.connectivity-test.outputs.ftp-available == 'true'
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ steps.connectivity-test.outputs.ftp-port || secrets.FTP_PORT || 2121 }}
          protocol: ${{ secrets.FTP_PROTOCOL || 'ftps' }}
          server-dir: ${{ steps.deploy-config.outputs.server-dir }}
          local-dir: ./cpanel-package/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
          log-level: standard
          security: loose
          timeout: 300000

      - name: Handle deployment failure
        if: failure() && steps.sftp-deploy.outcome != 'success' && steps.connectivity-test.outputs.ftp-available != 'true'
        run: |
          echo "## ‚ùå Deploy Falhou - Problemas de Conectividade" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Diagn√≥stico" >> $GITHUB_STEP_SUMMARY
          
          FTP_AVAILABLE="${{ steps.connectivity-test.outputs.ftp-available }}"
          SSH_AVAILABLE="${{ steps.connectivity-test.outputs.ssh-available }}"
          
          echo "- FTP (porta 21): $FTP_AVAILABLE" >> $GITHUB_STEP_SUMMARY
          echo "- SSH/SFTP (porta 22): $SSH_AVAILABLE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$FTP_AVAILABLE" != "true" ] && [ "$SSH_AVAILABLE" != "true" ]; then
            echo "**Problema:** Nenhuma porta est√° acess√≠vel!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üõ†Ô∏è Solu√ß√µes" >> $GITHUB_STEP_SUMMARY
            echo "1. Verifique se o servidor FTP est√° online" >> $GITHUB_STEP_SUMMARY
            echo "2. Confirme o IP/hostname est√° correto: \`${{ secrets.FTP_SERVER }}\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Verifique firewall/bloqueios de porta" >> $GITHUB_STEP_SUMMARY
            echo "4. Teste manualmente com: \`curl -v ftp://${{ secrets.FTP_SERVER }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "$SSH_AVAILABLE" == "true" ] && [ "${{ steps.sftp-deploy.outcome }}" != "success" ]; then
            echo "**Problema:** SSH est√° aberto mas SFTP falhou" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üõ†Ô∏è Solu√ß√µes" >> $GITHUB_STEP_SUMMARY
            echo "1. Verifique credenciais FTP_USERNAME/FTP_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "2. Confirme que o usu√°rio tem permiss√£o no diret√≥rio" >> $GITHUB_STEP_SUMMARY
            echo "3. Teste manualmente com: \`sshpass -p 'SENHA' ssh -o StrictHostKeyChecking=no USER@${{ secrets.FTP_SERVER }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          exit 1

      - name: Verify deployment
        run: |
          # Detectar m√©todo usado
          if [ "${{ steps.deploy-config.outputs.deploy-method }}" == "ssh" ]; then
            METHOD="SSH/SFTP (rsync)"
          elif [ "${{ steps.sftp-deploy.outcome }}" == "success" ]; then
            METHOD="SFTP (password)"
          else
            METHOD="FTP/FTPS"
          fi

          echo "‚úÖ Deploy conclu√≠do via $METHOD!"
          echo "üìä Estat√≠sticas do deploy:" >> $GITHUB_STEP_SUMMARY
          echo "- M√©todo: $METHOD" >> $GITHUB_STEP_SUMMARY
          echo "- Ambiente: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Post-deployment summary
        if: success()
        run: |
          echo "## üéâ Deploy Conclu√≠do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Passos Executados" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Pacote baixado e validado (SHA256)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Arquivos extra√≠dos e verificados" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Deploy via FTP conclu√≠do" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Edge Functions implantadas (Stage 6)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Pr√≥ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "1. Acesse: ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Verifique se o site carrega corretamente" >> $GITHUB_STEP_SUMMARY
          echo "3. Teste funcionalidades cr√≠ticas (login admin, inscri√ß√µes)" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitore logs do Supabase para Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Completo!** üöÄ‚úÖ" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed notification
        if: failure()
        run: |
          echo "## ‚ùå Deploy Falhou!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Falha em:** Stage 7 - Deploy to Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Poss√≠veis Causas" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Credenciais FTP incorretas ou expiradas" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Servidor FTP inacess√≠vel" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Diret√≥rio de destino n√£o existe ou sem permiss√£o" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Pacote corrompido ou incompleto" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üõ†Ô∏è A√ß√µes Recomendadas" >> $GITHUB_STEP_SUMMARY
          echo "1. Verifique os secrets no GitHub: FTP_SERVER, FTP_USERNAME, FTP_PASSWORD" >> $GITHUB_STEP_SUMMARY
          echo "2. Teste conex√£o FTP manualmente" >> $GITHUB_STEP_SUMMARY
          echo "3. Verifique logs detalhados acima" >> $GITHUB_STEP_SUMMARY
          echo "4. Se necess√°rio, fa√ßa deploy manual (docs/operacoes/deploy.md)" >> $GITHUB_STEP_SUMMARY
