name: "07 - Deploy to Environment"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment }}
      url: ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: cpanel-package-${{ github.sha }}

      - name: Verify package integrity
        run: |
          echo "ðŸ” Verificando integridade do pacote..."
          sha256sum -c civeni-cpanel.zip.sha256
          echo "âœ… Checksum validado com sucesso!"

      - name: Extract package
        run: |
          echo "ðŸ“¦ Extraindo pacote de deploy..."
          mkdir -p cpanel-package
          unzip -q civeni-cpanel.zip -d cpanel-package
          echo "âœ… Pacote extraÃ­do: $(ls -lh cpanel-package | wc -l) arquivos"

      - name: Verify extracted contents
        run: |
          echo "ðŸ” Verificando arquivos essenciais..."
          test -f cpanel-package/index.html && echo "âœ… index.html encontrado" || (echo "âŒ index.html nÃ£o encontrado" && exit 1)
          test -f cpanel-package/.htaccess && echo "âœ… .htaccess encontrado" || echo "âš ï¸ .htaccess nÃ£o encontrado"
          test -d cpanel-package/assets && echo "âœ… pasta assets/ encontrada" || (echo "âŒ pasta assets/ nÃ£o encontrada" && exit 1)

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_SERVER_DIR || '/public_html/' }}
          local-dir: ./cpanel-package/
          dangerous-clean-slate: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
          log-level: standard

      - name: Verify deployment
        run: |
          echo "âœ… Deploy via FTP concluÃ­do com sucesso!"
          echo "ðŸ“Š EstatÃ­sticas do deploy:" >> $GITHUB_STEP_SUMMARY
          echo "- Ambiente: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Post-deployment summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Deploy ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Passos Executados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pacote baixado e validado (SHA256)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Arquivos extraÃ­dos e verificados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deploy via FTP concluÃ­do" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Edge Functions implantadas (Stage 6)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” PrÃ³ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "1. Acesse: ${{ inputs.environment == 'production' && 'https://civeni.com' || 'https://staging.civeni.com' }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Verifique se o site carrega corretamente" >> $GITHUB_STEP_SUMMARY
          echo "3. Teste funcionalidades crÃ­ticas (login admin, inscriÃ§Ãµes)" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitore logs do Supabase para Edge Functions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Completo!** ðŸš€âœ…" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failed notification
        if: failure()
        run: |
          echo "## âŒ Deploy Falhou!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ambiente:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Falha em:** Stage 7 - Deploy to Environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” PossÃ­veis Causas" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Credenciais FTP incorretas ou expiradas" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Servidor FTP inacessÃ­vel" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ DiretÃ³rio de destino nÃ£o existe ou sem permissÃ£o" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Pacote corrompido ou incompleto" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ AÃ§Ãµes Recomendadas" >> $GITHUB_STEP_SUMMARY
          echo "1. Verifique os secrets no GitHub: FTP_SERVER, FTP_USERNAME, FTP_PASSWORD" >> $GITHUB_STEP_SUMMARY
          echo "2. Teste conexÃ£o FTP manualmente" >> $GITHUB_STEP_SUMMARY
          echo "3. Verifique logs detalhados acima" >> $GITHUB_STEP_SUMMARY
          echo "4. Se necessÃ¡rio, faÃ§a deploy manual (docs/operacoes/deploy.md)" >> $GITHUB_STEP_SUMMARY
