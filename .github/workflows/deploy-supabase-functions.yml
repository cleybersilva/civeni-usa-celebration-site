name: Deploy Supabase Functions

on:
  workflow_dispatch:
    inputs:
      function_name:
        description: 'Function to deploy (leave empty to deploy all)'
        required: false
        type: string
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
        default: production

jobs:
  deploy:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy specific function
        if: ${{ github.event.inputs.function_name != '' }}
        run: |
          echo "Deploying function: ${{ github.event.inputs.function_name }}"
          supabase functions deploy ${{ github.event.inputs.function_name }} --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all functions
        if: ${{ github.event.inputs.function_name == '' }}
        run: |
          echo "Deploying all Edge Functions..."

          # Get list of all functions
          FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)

          echo "Found functions:"
          echo "$FUNCTIONS"

          # Deploy each function
          for func in $FUNCTIONS; do
            echo "Deploying $func..."
            supabase functions deploy $func --no-verify-jwt || echo "Failed to deploy $func"
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Set function secrets
        if: ${{ github.event.inputs.environment == 'production' }}
        run: |
          echo "Setting production secrets for functions..."
          # Add your secret-setting commands here if needed
          # Example: supabase secrets set STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully"
          echo "Environment: ${{ github.event.inputs.environment }}"
          if [ -n "${{ github.event.inputs.function_name }}" ]; then
            echo "Function deployed: ${{ github.event.inputs.function_name }}"
          else
            echo "All functions deployed"
          fi
