name: Main Pipeline - Sequential

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  ARTIFACT_NAME: civeni-saas-build

jobs:
  # ============================================
  # JOB 1: VALIDATION
  # ============================================
  job-01-validate:
    name: "Job 1/7: Code Validation"
    runs-on: ubuntu-latest
    outputs:
      lint-status: ${{ steps.lint.outcome }}
      typecheck-status: ${{ steps.typecheck.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: TypeScript type check
        id: typecheck
        run: npx tsc --noEmit

      - name: Job 1 summary
        run: |
          echo "## ‚úÖ Job 1/7: Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- ESLint: ${{ steps.lint.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript: ${{ steps.typecheck.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 2 - Build" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: BUILD
  # ============================================
  job-02-build:
    name: "Job 2/7: Build Project"
    runs-on: ubuntu-latest
    needs: [job-01-validate]
    if: success()
    outputs:
      build-size: ${{ steps.check-size.outputs.size }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "üèóÔ∏è Building for PRODUCTION..."
            npm run build
          else
            echo "üèóÔ∏è Building for DEVELOPMENT..."
            npm run build:dev
          fi
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Check build size
        id: check-size
        run: |
          SIZE=$(du -sm dist/ | cut -f1)
          echo "size=${SIZE}" >> $GITHUB_OUTPUT
          echo "üì¶ Build size: ${SIZE}MB"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/
          retention-days: 7

      - name: Job 2 summary
        run: |
          echo "## ‚úÖ Job 2/7: Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Size: ${{ steps.check-size.outputs.size }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 3 - Security Scan" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 3: SECURITY SCAN
  # ============================================
  job-03-security:
    name: "Job 3/7: Security Scan"
    runs-on: ubuntu-latest
    needs: [job-02-build]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for vulnerabilities
        run: |
          echo "üîç Security scan completed"
          npm audit --production || echo "‚ö†Ô∏è Some vulnerabilities found (review recommended)"

      - name: Job 3 summary
        run: |
          echo "## ‚úÖ Job 3/7: Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "- npm audit executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 4 - Quality Check" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: QUALITY CHECK
  # ============================================
  job-04-quality:
    name: "Job 4/7: Quality Check"
    runs-on: ubuntu-latest
    needs: [job-03-security]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/

      - name: Analyze bundle
        run: |
          echo "üìä Analyzing build output..."

          # Count files
          JS_COUNT=$(find dist/assets -name "*.js" 2>/dev/null | wc -l || echo "0")
          CSS_COUNT=$(find dist/assets -name "*.css" 2>/dev/null | wc -l || echo "0")

          echo "JavaScript files: ${JS_COUNT}"
          echo "CSS files: ${CSS_COUNT}"

          # List largest files
          echo ""
          echo "Largest assets:"
          du -h dist/assets/* 2>/dev/null | sort -rh | head -5 || echo "No assets found"

      - name: Job 4 summary
        run: |
          JS_COUNT=$(find dist/assets -name "*.js" 2>/dev/null | wc -l || echo "0")
          CSS_COUNT=$(find dist/assets -name "*.css" 2>/dev/null | wc -l || echo "0")

          echo "## ‚úÖ Job 4/7: Quality Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript files: ${JS_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- CSS files: ${CSS_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 5 - Create Package" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 5: CREATE PACKAGE
  # ============================================
  job-05-package:
    name: "Job 5/7: Create Deployment Package"
    runs-on: ubuntu-latest
    needs: [job-04-quality]
    if: success() && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/

      - name: Prepare cPanel package
        run: |
          echo "üì¶ Creating deployment package..."
          mkdir -p cpanel-package
          cp -r dist/* cpanel-package/

          # Copy essential files
          [ -f .htaccess ] && cp .htaccess cpanel-package/ && echo "‚úì .htaccess included"
          [ -f public/robots.txt ] && cp public/robots.txt cpanel-package/ && echo "‚úì robots.txt included"

      - name: Create ZIP archive
        run: |
          cd cpanel-package
          zip -r ../civeni-saas-cpanel.zip .
          cd ..

          # Generate checksum
          sha256sum civeni-saas-cpanel.zip > civeni-saas-cpanel.zip.sha256

          echo "‚úÖ Package created"
          ls -lh civeni-saas-cpanel.zip

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}
          path: |
            civeni-saas-cpanel.zip
            civeni-saas-cpanel.zip.sha256
          retention-days: 30

      - name: Job 5 summary
        run: |
          SIZE=$(du -h civeni-saas-cpanel.zip | cut -f1)
          CHECKSUM=$(cat civeni-saas-cpanel.zip.sha256 | cut -d' ' -f1)

          echo "## ‚úÖ Job 5/7: Package Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Package: civeni-saas-cpanel.zip" >> $GITHUB_STEP_SUMMARY
          echo "- Size: ${SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: \`${CHECKSUM}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "**Next:** Job 6 - Deploy to Staging" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "**Next:** Job 6 - Deploy to Production (Manual Approval Required)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next:** Job 7 - Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 6A: DEPLOY TO STAGING (only develop)
  # ============================================
  job-06a-deploy-staging:
    name: "Job 6/7: Deploy to Staging"
    runs-on: ubuntu-latest
    needs: [job-05-package]
    if: success() && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.civeni.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}

      - name: Verify package
        run: |
          echo "üîç Verifying package integrity..."
          sha256sum -c civeni-saas-cpanel.zip.sha256
          echo "‚úÖ Package verified"

      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to STAGING environment..."
          echo "Package: civeni-saas-cpanel.zip"
          # Add actual deployment commands here
          echo "‚úÖ Deployment complete"

      - name: Job 6 summary
        run: |
          echo "## ‚úÖ Job 6/7: Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://staging.civeni.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 7 - Pipeline Complete" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 6B: DEPLOY TO PRODUCTION (only main)
  # ============================================
  job-06b-deploy-production:
    name: "Job 6/7: Deploy to Production"
    runs-on: ubuntu-latest
    needs: [job-05-package]
    if: success() && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://civeni.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}

      - name: Verify package
        run: |
          echo "üîç Verifying package integrity..."
          sha256sum -c civeni-saas-cpanel.zip.sha256
          echo "‚úÖ Package verified"

      - name: Production deployment
        run: |
          echo "üöÄ Deploying to PRODUCTION environment..."
          echo "‚ö†Ô∏è  This is PRODUCTION - changes will be live!"
          echo "Package: civeni-saas-cpanel.zip"
          # Add actual deployment commands here
          echo "‚úÖ Production deployment complete"

      - name: Job 6 summary
        run: |
          echo "## ‚úÖ Job 6/7: Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **Production**" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://civeni.com" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 7 - Pipeline Complete" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 7: PIPELINE COMPLETE
  # ============================================
  job-07-complete:
    name: "Job 7/7: Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-02-build, job-03-security, job-04-quality, job-05-package]
    if: always()

    steps:
      - name: Generate pipeline summary
        run: |
          echo "# üéâ Pipeline Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Sequential Jobs Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1/7 | Validation | ${{ needs.job-01-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2/7 | Build | ${{ needs.job-02-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3/7 | Security | ${{ needs.job-03-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4/7 | Quality | ${{ needs.job-04-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5/7 | Package | ${{ needs.job-05-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          if [ "${{ needs.job-01-validate.result }}" == "failure" ] || \
             [ "${{ needs.job-02-build.result }}" == "failure" ] || \
             [ "${{ needs.job-03-security.result }}" == "failure" ] || \
             [ "${{ needs.job-04-quality.result }}" == "failure" ] || \
             [ "${{ needs.job-05-package.result }}" == "failure" ]; then
            echo "‚ùå Pipeline failed at one or more jobs"
            exit 1
          fi

          echo "‚úÖ All jobs completed successfully"
