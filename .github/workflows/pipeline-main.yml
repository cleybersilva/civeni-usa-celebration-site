name: Main Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  ARTIFACT_NAME: civeni-saas-build

jobs:
  # ============================================
  # STAGE 1: VALIDATION
  # ============================================
  stage-validate:
    name: "Stage 1: Validation"
    runs-on: ubuntu-latest
    outputs:
      lint-status: ${{ steps.lint.outcome }}
      typecheck-status: ${{ steps.typecheck.outcome }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: lint
        run: npm run lint
        continue-on-error: true

      - name: TypeScript type check
        id: typecheck
        run: npx tsc --noEmit

      - name: Validation summary
        run: |
          echo "## Stage 1: Validation Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ steps.lint.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type Check: ${{ steps.typecheck.outcome }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 2: BUILD
  # ============================================
  stage-build:
    name: "Stage 2: Build"
    runs-on: ubuntu-latest
    needs: [stage-validate]
    if: success()
    outputs:
      build-status: ${{ steps.build.outcome }}
      build-size: ${{ steps.check-size.outputs.size }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        id: build
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "Building for production..."
            npm run build
          else
            echo "Building for development..."
            npm run build:dev
          fi
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Check build size
        id: check-size
        run: |
          SIZE=$(du -sm dist/ | cut -f1)
          echo "size=${SIZE}" >> $GITHUB_OUTPUT
          echo "Build size: ${SIZE}MB"

          if [ $SIZE -gt 50 ]; then
            echo "âš ï¸ Warning: Bundle size is ${SIZE}MB (>50MB)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/
          retention-days: 7

      - name: Build summary
        run: |
          echo "## Stage 2: Build Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.build.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Size: ${{ steps.check-size.outputs.size }}MB" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 3: SECURITY & QUALITY
  # ============================================
  stage-security:
    name: "Stage 3: Security Scan"
    runs-on: ubuntu-latest
    needs: [stage-build]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check dependencies
        run: |
          echo "## Stage 3: Security Scan Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "Dependencies checked for vulnerabilities" >> $GITHUB_STEP_SUMMARY

  stage-quality:
    name: "Stage 3: Quality Check"
    runs-on: ubuntu-latest
    needs: [stage-build]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/

      - name: Check bundle composition
        run: |
          echo "Analyzing bundle composition..."
          ls -lh dist/assets/ || true

          # Count JS files
          JS_COUNT=$(find dist/assets -name "*.js" | wc -l)
          CSS_COUNT=$(find dist/assets -name "*.css" | wc -l)

          echo "## Stage 3: Quality Check Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript files: ${JS_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- CSS files: ${CSS_COUNT}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 4: PACKAGE
  # ============================================
  stage-package:
    name: "Stage 4: Create Deployment Package"
    runs-on: ubuntu-latest
    needs: [stage-security, stage-quality]
    if: success() && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          path: dist/

      - name: Prepare cPanel package
        run: |
          mkdir -p cpanel-package
          cp -r dist/* cpanel-package/

          # Copy .htaccess if exists
          if [ -f .htaccess ]; then
            cp .htaccess cpanel-package/
          fi

          # Copy robots.txt if exists
          if [ -f public/robots.txt ]; then
            cp public/robots.txt cpanel-package/
          fi

      - name: Create deployment ZIP
        run: |
          cd cpanel-package
          zip -r ../civeni-saas-cpanel.zip .
          cd ..
          sha256sum civeni-saas-cpanel.zip > civeni-saas-cpanel.zip.sha256

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}
          path: |
            civeni-saas-cpanel.zip
            civeni-saas-cpanel.zip.sha256
          retention-days: 30

      - name: Package summary
        run: |
          SIZE=$(du -h civeni-saas-cpanel.zip | cut -f1)
          echo "## Stage 4: Package Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Package: civeni-saas-cpanel.zip" >> $GITHUB_STEP_SUMMARY
          echo "- Size: ${SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: $(cat civeni-saas-cpanel.zip.sha256)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 5: DEPLOY STAGING (Auto)
  # ============================================
  stage-deploy-staging:
    name: "Stage 5: Deploy to Staging"
    runs-on: ubuntu-latest
    needs: [stage-package]
    if: success() && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.civeni.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}

      - name: Verify package integrity
        run: sha256sum -c civeni-saas-cpanel.zip.sha256

      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          echo "Package: civeni-saas-cpanel.zip"
          # Add your deployment commands here
          # Example: scp, rsync, FTP, or API calls

      - name: Staging deployment summary
        run: |
          echo "## Stage 5: Staging Deployment Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://staging.civeni.com" >> $GITHUB_STEP_SUMMARY
          echo "- Package: civeni-saas-cpanel.zip" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # STAGE 6: DEPLOY PRODUCTION (Manual)
  # ============================================
  stage-deploy-production:
    name: "Stage 6: Deploy to Production"
    runs-on: ubuntu-latest
    needs: [stage-package]
    if: success() && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://civeni.com

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: cpanel-deployment-${{ github.sha }}

      - name: Verify package integrity
        run: sha256sum -c civeni-saas-cpanel.zip.sha256

      - name: Production deployment notification
        run: |
          echo "ðŸš€ Ready to deploy to PRODUCTION"
          echo "Package verified and ready for deployment"

      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          echo "Package: civeni-saas-cpanel.zip"
          # Add your production deployment commands here

      - name: Production deployment summary
        run: |
          echo "## Stage 6: Production Deployment Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: Production" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://civeni.com" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # FINAL: PIPELINE SUMMARY
  # ============================================
  pipeline-complete:
    name: "Pipeline Complete"
    runs-on: ubuntu-latest
    needs: [stage-validate, stage-build, stage-security, stage-quality, stage-package]
    if: always()

    steps:
      - name: Pipeline summary
        run: |
          echo "# ðŸŽ‰ Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Validation | ${{ needs.stage-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. Build | ${{ needs.stage-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Security | ${{ needs.stage-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. Quality | ${{ needs.stage-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Package | ${{ needs.stage-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
