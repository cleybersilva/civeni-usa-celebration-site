name: Release Pipeline - Sequential

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-rc.*'
      - 'v*.*.*-beta.*'

env:
  NODE_VERSION: '20'
  SUPABASE_CLI_VERSION: 'latest'

jobs:
  # ============================================
  # JOB 1: VALIDATE RELEASE
  # ============================================
  job-01-validate:
    name: "Job 1/6: Validate Release"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-prerelease: ${{ steps.check-prerelease.outputs.prerelease }}
      changelog: ${{ steps.get-changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: ${VERSION}"

      - name: Check if pre-release
        id: check-prerelease
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if [[ "$VERSION" =~ (rc|beta|alpha|test) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¶ This is a PRE-RELEASE"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "âœ… This is a STABLE release"
          fi

      - name: Get changelog
        id: get-changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" ${LAST_TAG}..HEAD)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Job 1 summary
        run: |
          echo "## âœ… Job 1/6: Release Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ steps.get-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release: ${{ steps.check-prerelease.outputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 2 - Build Frontend" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: BUILD FRONTEND
  # ============================================
  job-02-build-frontend:
    name: "Job 2/6: Build Frontend"
    runs-on: ubuntu-latest
    needs: [job-01-validate]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: Build production
        run: npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}

      - name: Upload build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ needs.job-01-validate.outputs.version }}
          path: dist/
          retention-days: 90

      - name: Job 2 summary
        run: |
          SIZE=$(du -sh dist/ | cut -f1)
          echo "## âœ… Job 2/6: Frontend Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Build size: ${SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.job-01-validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 3 - Validate Supabase Functions" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 3: VALIDATE SUPABASE FUNCTIONS
  # ============================================
  job-03-validate-functions:
    name: "Job 3/6: Validate Functions"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-02-build-frontend]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Validate all functions
        run: |
          echo "ðŸ” Validating all Edge Functions..."
          FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
          ERROR_COUNT=0

          for func in $FUNCTIONS; do
            if [ -f "supabase/functions/$func/index.ts" ]; then
              echo "Validating $func..."
              if deno check supabase/functions/$func/index.ts; then
                echo "  âœ… $func"
              else
                echo "  âŒ $func"
                ERROR_COUNT=$((ERROR_COUNT+1))
              fi
            fi
          done

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "âŒ Found $ERROR_COUNT error(s)"
            exit 1
          fi

          echo "âœ… All functions validated"

      - name: Job 3 summary
        run: |
          COUNT=$(ls -d supabase/functions/*/ | wc -l)
          echo "## âœ… Job 3/6: Functions Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Functions validated: ${COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 4 - Create Package" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: CREATE DEPLOYMENT PACKAGE
  # ============================================
  job-04-package:
    name: "Job 4/6: Create Package"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-02-build-frontend, job-03-validate-functions]
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ needs.job-01-validate.outputs.version }}
          path: dist/

      - name: Create cPanel package
        run: |
          VERSION="${{ needs.job-01-validate.outputs.version }}"
          echo "ðŸ“¦ Creating deployment package for ${VERSION}..."

          mkdir -p cpanel-package
          cp -r dist/* cpanel-package/

          # Copy essential files
          [ -f .htaccess ] && cp .htaccess cpanel-package/ && echo "âœ“ .htaccess"
          [ -f public/robots.txt ] && cp public/robots.txt cpanel-package/ && echo "âœ“ robots.txt"

          # Create versioned ZIP
          cd cpanel-package
          zip -r ../civeni-saas-cpanel-${VERSION}.zip .
          cd ..

          # Generate checksum
          sha256sum civeni-saas-cpanel-${VERSION}.zip > civeni-saas-cpanel-${VERSION}.zip.sha256

          echo "âœ… Package created"
          ls -lh civeni-saas-cpanel-${VERSION}.zip

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ needs.job-01-validate.outputs.version }}
          path: |
            civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip
            civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip.sha256
          retention-days: 365

      - name: Job 4 summary
        run: |
          VERSION="${{ needs.job-01-validate.outputs.version }}"
          SIZE=$(du -h civeni-saas-cpanel-${VERSION}.zip | cut -f1)
          CHECKSUM=$(cat civeni-saas-cpanel-${VERSION}.zip.sha256 | cut -d' ' -f1)

          echo "## âœ… Job 4/6: Package Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Package: civeni-saas-cpanel-${VERSION}.zip" >> $GITHUB_STEP_SUMMARY
          echo "- Size: ${SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA256: \`${CHECKSUM}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.job-01-validate.outputs.is-prerelease }}" == "true" ]; then
            echo "**Next:** Job 6 - Create GitHub Release (Deploy skipped for pre-release)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next:** Job 5 - Deploy Functions (Requires Approval)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 5: DEPLOY SUPABASE FUNCTIONS (stable only)
  # ============================================
  job-05-deploy-functions:
    name: "Job 5/6: Deploy Functions"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-04-package]
    if: success() && needs.job-01-validate.outputs.is-prerelease == 'false'
    environment:
      name: supabase-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: ${{ env.SUPABASE_CLI_VERSION }}

      - name: Link Supabase project
        run: |
          echo "ðŸ”— Linking to Supabase production..."
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all functions
        run: |
          echo "ðŸš€ Deploying all functions to PRODUCTION..."
          FUNCTIONS=$(ls -d supabase/functions/*/ | xargs -n 1 basename)
          SUCCESS=0
          FAILED=0

          for func in $FUNCTIONS; do
            echo "Deploying $func..."
            if supabase functions deploy $func --no-verify-jwt; then
              SUCCESS=$((SUCCESS+1))
            else
              FAILED=$((FAILED+1))
            fi
          done

          echo "âœ… Deployed: $SUCCESS functions"
          if [ $FAILED -gt 0 ]; then
            echo "âŒ Failed: $FAILED functions"
            exit 1
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Job 5 summary
        run: |
          echo "## âœ… Job 5/6: Functions Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- All functions deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next:** Job 6 - Create GitHub Release (Requires Approval)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 6: CREATE GITHUB RELEASE
  # ============================================
  job-06-create-release:
    name: "Job 6/6: Create Release"
    runs-on: ubuntu-latest
    needs: [job-01-validate, job-04-package, job-05-deploy-functions]
    if: success() || (success() && needs.job-01-validate.outputs.is-prerelease == 'true')
    environment:
      name: github-release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package-${{ needs.job-01-validate.outputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ needs.job-01-validate.outputs.version }}
          tag_name: ${{ needs.job-01-validate.outputs.version }}
          prerelease: ${{ needs.job-01-validate.outputs.is-prerelease }}
          generate_release_notes: true
          body: |
            # ðŸš€ Release ${{ needs.job-01-validate.outputs.version }}

            ## ðŸ“¦ Deployment Package

            Download the cPanel deployment package below.

            ### Installation Instructions

            1. Download `civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip`
            2. Verify integrity:
               ```bash
               sha256sum -c civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip.sha256
               ```
            3. Upload to cPanel File Manager
            4. Extract to `public_html/` or domain root
            5. Verify `.htaccess` is present
            6. Test the deployment

            ## ðŸ“ Changes

            ${{ needs.job-01-validate.outputs.changelog }}

            ## ðŸ”§ Technical Details

            - **Node Version:** ${{ env.NODE_VERSION }}
            - **Release Type:** ${{ needs.job-01-validate.outputs.is-prerelease == 'true' && 'Pre-release' || 'Stable' }}
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            - **Released by:** ${{ github.actor }}

            ---

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          files: |
            civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip
            civeni-saas-cpanel-${{ needs.job-01-validate.outputs.version }}.zip.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job 6 summary
        run: |
          echo "## âœ… Job 6/6: GitHub Release Created" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.job-01-validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release: ${{ needs.job-01-validate.outputs.is-prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.job-01-validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pipeline Complete** âœ…" >> $GITHUB_STEP_SUMMARY
