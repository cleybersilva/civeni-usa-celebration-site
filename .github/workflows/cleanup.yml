name: Cleanup

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  delete-old-artifacts:
    name: Delete Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Delete artifacts older than 30 days
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get all artifacts
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });

            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            let deletedCount = 0;

            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);

              if (createdAt < thirtyDaysAgo) {
                console.log(`Deleting artifact: ${artifact.name} (created: ${artifact.created_at})`);

                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });

                deletedCount++;
              }
            }

            console.log(`Deleted ${deletedCount} artifact(s)`);

  delete-old-workflow-runs:
    name: Delete Old Workflow Runs
    runs-on: ubuntu-latest

    steps:
      - name: Delete workflow runs older than 90 days
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });

            let deletedCount = 0;

            for (const workflow of workflows.data.workflows) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                per_page: 100
              });

              for (const run of runs.data.workflow_runs) {
                const createdAt = new Date(run.created_at);

                // Only delete old failed or cancelled runs
                if (createdAt < ninetyDaysAgo && (run.conclusion === 'failure' || run.conclusion === 'cancelled')) {
                  console.log(`Deleting run: ${run.name} #${run.run_number} (${run.conclusion})`);

                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });

                  deletedCount++;
                }
              }
            }

            console.log(`Deleted ${deletedCount} workflow run(s)`);
